<?php

namespace Qero\PackagesManager;
use Qero\Printer\Printer;

define ('QERO_AUTOGENERATE', '

/*
    Auto generated by Qero '. \Qero\QERO_VERSION .'
    '. date ('Y/m/d H:i:s') .' (timestamp: '. time () .')
*/

');

class PackagesManager
{
    protected $settings = array ();
    protected $parse = array
    (
        'version',
        'entry_point'
    );

    protected $enteringPoints = array
    (
        'qero-init.php',
        'qero-main.php',
        'main.php',
        'index.php',
        'autorun.php',
        'startup.php'
    );

    public function __construct ()
    {
        if (!file_exists (QERO_DIR .'/qero-packages/qero-info.json'))
            $this->updateSettings ();
        
        $this->settings = json_decode (file_get_contents (QERO_DIR .'/qero-packages/qero-info.json'), true);
    }

    public function installPackage (string $package): bool
    {
        $info = json_decode (@file_get_contents ('http://api.github.com/repos/'. $package, false, stream_context_create (array (
            'http' => array
            (
                'method' => 'GET',
                'header' => array ('User-Agent: PHP')
            )
        ))), true);

        if (!is_array ($info) || isset ($info['message']))
        {
            Printer::print ('Repository "'. $package .'" not founded. Skipping...');

            return false;
        }

        Printer::print ('Installing "'. $package .'"...');

        $commit = json_decode (file_get_contents ('http://api.github.com/repos/'. $package .'/commits', false, stream_context_create (array (
            'http' => array
            (
                'method' => 'GET',
                'header' => array ('User-Agent: PHP')
            )
        ))), true);
        $commit = $commit[0];

        \Qero\dir_delete (QERO_DIR .'/qero-packages/'. $info['full_name']);
        mkdir (QERO_DIR .'/qero-packages/'. $info['full_name'], 0777, true);

        file_put_contents (QERO_DIR .'/qero-packages/'. $info['full_name'] .'/branch.tar', file_get_contents ('http://api.github.com/repos/'. $package .'/tarball', false, stream_context_create (array (
            'http' => array
            (
                'method' => 'GET',
                'header' => array ('User-Agent: PHP')
            )
        ))));

        $archive = new \PharData (QERO_DIR .'/qero-packages/'. $info['full_name'] .'/branch.tar');
        $archive->extractTo (QERO_DIR .'/qero-packages/'. $info['full_name']);

        unlink (QERO_DIR .'/qero-packages/'. $info['full_name'] .'/branch.tar');

        $this->registerNewPackage ($info['full_name'], $commit);

        return true;
    }

    public function registerNewPackage (string $package, array $packageInfo): void
    {
        $this->settings['packages'][$package] = array
        (
            'folder'  => str_replace ('/', '-', $package) .'-'. substr ($packageInfo['sha'], 0, 7),
            'sha'     => $packageInfo['sha'],
            'node_id' => $packageInfo['node_id']
        );

        $folder = QERO_DIR .'/qero-packages/'. $package .'/'. $this->settings['packages'][$package]['folder'];
        $info   = array ();

        if (file_exists ($folder .'/qero-info.json'))
        {
            $info = json_decode (file_get_contents ($folder .'/qero-info.json'), true);

            foreach ($this->parse as $parse)
                if (isset ($info[$parse]))
                    $this->settings['packages'][$package][$parse] = $info[$parse];
        }

        if (!isset ($this->settings['packages'][$package]['entry_point']))
        {
            $name = explode ('/', $package);
            
            foreach (array_merge (array (end ($name) .'.php'), $this->enteringPoints) as $entryPoint)
                if (file_exists ($folder .'/'. $entryPoint))
                {
                    $this->settings['packages'][$package]['entry_point'] = $entryPoint;

                    break;
                }

            if (!isset ($this->settings['packages'][$package]['entry_point']))
            {
                $this->settings['packages'][$package]['entry_point'] = 'qero-init.php';

                file_put_contents ($folder .'/qero-init.php', '<?php'. QERO_AUTOGENERATE . implode ("\n", array_map (function ($file)
                {
                    return '@require \''. $file .'\';';
                }, $this->getPhpsList ($folder))) ."\n\n?>\n");
            }
        }

        if (isset ($info['requires']))
        {
            $this->settings['packages'][$package]['requires'] = $info['requires'];

            foreach ($info['requires'] as $repository)
                $this->installPackage ($repository);
        }

        $this->updateSettings ();
        $this->constructAutoloadFile ();
    }

    public function deletePackage (string $package)
    {
        \Qero\dir_delete (QERO_DIR .'/qero-packages/'. $package);

        if (sizeof (scandir (dirname (QERO_DIR .'/qero-packages/'. $package))) <= 2)
            \Qero\dir_delete (dirname (QERO_DIR .'/qero-packages/'. $package));

        unset ($this->settings['packages'][$package]);
        
        $this->updateSettings ();
        $this->constructAutoloadFile ();
    }

    public function updatePackages ()
    {
        if (is_array ($this->settings['packages']))
        {
            $repos = array_keys ($this->settings['packages']);

            foreach ($repos as $repo)
                if (isset ($this->settings['packages'][$repo]['requires']))
                    foreach ($this->settings['packages'][$repo]['requires'] as $requirement)
                        if (($index = array_search ($requirement, $repos)) !== false)
                            unset ($repos[$index]);

            foreach ($repos as $repository)
                $this->installPackage ($repository);
        }
    }

    protected function getPhpsList (string $folder, string $basefolder = null): array
    {
        $list = array ();

        if ($basefolder === null)
            $basefolder = $folder .'/';

        foreach (array_slice (scandir ($folder), 2) as $file)
        {
            $ext = explode ('.', $file);

            if (strtolower (end ($ext)) == 'php')
                $list[] = str_replace ($basefolder, '', $folder .'/'. $file);

            elseif (is_dir ($folder .'/'. $file))
                $list = array_merge ($list, $this->getPhpsList ($folder .'/'. $file, $basefolder));
        }

        return $list;
    }

    public function constructAutoloadFile (): void
    {
        $packages = $this->settings['packages'];

        $autoload  = '<?php'. QERO_AUTOGENERATE;
        $autoload .= implode ("\n", array_map (function ($file) use ($packages)
        {
            return 'require \''. $file .'/'. $packages[$file]['folder'] .'/'. $packages[$file]['entry_point'] .'\';';
        }, $this->getRequires (array_keys ($this->settings['packages']))));

        file_put_contents (QERO_DIR .'/qero-packages/autoload.php', $autoload ."\n\n?>\n");
    }

    protected function getRequires (array $packages, array $requires = array ()): array
    {
        foreach ($packages as $package)
            if (!isset ($this->settings['packages'][$package]['requires']))
            {
                if (array_search ($package, $requires) === false)
                    $requires[] = $package;
            }

            else $requires = array_merge ($requires, $this->settings['packages'][$package]['requires'], array ($package));

        return $requires;
    }

    public function updateSettings (): void
    {
        file_put_contents (QERO_DIR .'/qero-packages/qero-info.json', json_encode ($this->settings, JSON_PRETTY_PRINT));
    }
}

?>
